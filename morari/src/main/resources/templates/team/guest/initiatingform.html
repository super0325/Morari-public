<!DOCTYPE html>
<html lang="zh-TW">

<head>
<script src="/morari/guest/js/head.js"></script>
<!-- sharepage 公用頁面 -->
<script src="/morari/guest/js/share.js"></script>


</head>

<body style="display: none">
	<!-- Header Section Start -->
	<div class="header"></div>

	<!-- Header Section End -->

	<!-- 分離範例 -->
	<script src="/morari/team/js/test.js"></script>

	<div id="rooms">
		<div class="container">

			<div id="amenities">
				<div class="container">
					<div class="section-header">
						<h2 id="title"></h2>
						<p id="introduction"></p>
					</div>
					<div class="row">
						<div class="col-md-3 col-sm-6">
							<div class="item">
								<i class="icon icon-2"></i>
								<h3>發文會員/時間</h3>
								<p id="postmember"></p>
							</div>
						</div>
						<div class="col-md-3 col-sm-6">
							<div class="item">
								<i class="icon icon-3"></i>
								<h3>補充說明</h3>
								<p id="tag"></p>
							</div>
						</div>
						<div class="col-md-3 col-sm-6">
							<div class="item">
								<i class="icon icon-4"></i>
								<h3>開始時間</h3>
								<p id="startday"></p>
							</div>
						</div>
						<div class="col-md-3 col-sm-6">
							<div class="item">
								<i class="icon icon-6"></i>
								<h3>結束時間</h3>
								<p id="endday"></p>
							</div>
						</div>
						<div class="col-md-3 col-sm-6">
							<div class="item">
								<i class="icon icon-7"></i>
								<h3>可接受人數</h3>
								<p id="acceptablenum"></p>
							</div>
						</div>
						<div class="col-md-3 col-sm-6">
							<div class="item">
								<i class="icon icon-8"></i>
								<h3>目前人數</h3>
								<p id="currentnum"></p>
							</div>
						</div>
						<div class="col-md-3 col-sm-6">
							<div class="item">
								<i class="icon icon-9"></i>
								<h3>露營地點</h3>
								<p id="camparea"></p>
							</div>
						</div>
						<div class="col-md-3 col-sm-6">
							<div class="item">
								<i class="icon icon-10"></i>
								<h3>配對狀態</h3>
								<p id="pair"></p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<div id="booking">
		<div class="container">
			<div class="row">
				<div class="col-6">
					<div class="booking-form">
						<div id="messageview"></div>
						<form name="sentMessage" id="sentMessage" novalidate="novalidate">
							<div class="control-group">
								<label>留言：</label> <input type="text" class="form-control"
									name="message" id="request" placeholder="說點什麼吧"
									required="required"
									data-validation-required-message="Please enter your special request">
								<p class="help-block text-danger"></p>
							</div>
							<div class="button">
								<button type="submit" id="messageButton">發送</button>
							</div>
						</form>
					</div>
				</div>
				<div class="col-6">
					<div class="booking-form">
						<div id="messageview"></div>
						<form name="sentApply" id="sentApply" novalidate="novalidate">
							<div class="control-group">
								<label>想說的話：</label> <input type="text" class="form-control"
									name="applymessage" id="applymessage" placeholder="說點什麼吧"
									required="required"
									data-validation-required-message="Please enter your special request">
								<p class="help-block text-danger"></p>
								<label>申請人數：</label> <input type="number" class="form-control"
									name="applypeople" id="applypeople"
									required="required"
									data-validation-required-message="Please enter your special request">
								<p class="help-block text-danger"></p>
								<div class="button">
									<button type="submit" id="apply" >我想加入</button>
								</div>
							</div>
						</form>
						<br>
						<div id="update"></div>
						
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer Section Start -->
	<div class="footer"></div>
	<!-- Footer Section End -->

	<a href="#" class="back-to-top"><i class="fa fa-chevron-up"></i></a>


	<!-- Vendor JavaScript File -->
	<script src="/morari/guest/vendor/jquery/jquery.min.js"></script>
	<script src="/morari/guest/vendor/jquery/jquery-migrate.min.js" defer></script>
	<script src="/morari/guest/vendor/bootstrap/js/bootstrap.bundle.min.js"
		defer></script>
	<script src="/morari/guest/vendor/easing/easing.min.js" defer></script>
	<script src="/morari/guest/vendor/stickyjs/sticky.js" defer></script>
	<script src="/morari/guest/vendor/superfish/hoverIntent.js" defer></script>
	<script src="/morari/guest/vendor/superfish/superfish.min.js" defer></script>
	<script src="/morari/guest/vendor/wow/wow.min.js" defer></script>
	<script src="/morari/guest/vendor/slick/slick.min.js" defer></script>
	<script src="/morari/guest/vendor/tempusdominus/js/moment.min.js" defer></script>
	<script
		src="/morari/guest/vendor/tempusdominus/js/moment-timezone.min.js"
		defer></script>
	<script
		src="/morari/guest/vendor/tempusdominus/js/tempusdominus-bootstrap-4.min.js"
		defer></script>

	<!-- Booking Javascript File -->
	<script src="/morari/guest/js/booking.js" defer></script>
	<script src="/morari/guest/js/jqBootstrapValidation.min.js" defer></script>

	<!-- Main Javascript File -->
	<script src="/morari/guest/js/main.js" defer></script>

	<script type="text/javascript">
  
  var user;
  
  var num;
  
  var initiatingUser;
  
  var limit;
  
  var pair;
  
  $(function () {
	    $(document).ready(function () {
	    	
	    	let url = window.location.href;
	    	let parts = url.split(/\//);
	    	num = parts[parts.length - 1];
	    	console.log(num);
	    	
	    	fetch("/morari/utils/getuid")
	    	.then(response => response.text())
	    	.then(data => {
	    		console.log(data)
	    		user = data;
	    		
	    		fetch('/morari/team/findById.controller/{'+ num +"}" , { method: 'POST' }).then(
						function (response) {
							if (response.status != 200) {
								console.log(response.satus);
								return;
							}
							
							console.log(response);

							response.json().then(function (data) {
								
								var input = data.tag;
								var items = input.split(";");
								var result = "";
								for (var i = 0; i < items.length; i++) {
							    	var parts = items[i].split(":");
							    	result += parts[0] + "<br>";
								}
								result = result.slice(0,-4)
								
								console.log(result)
									
									var pDay = new Date(data.postdate).toLocaleDateString("zh-TW", {year: 'numeric', month: '2-digit', day: '2-digit'});
									var sDay = new Date(data.startdate).toLocaleDateString("zh-TW", {year: 'numeric', month: '2-digit', day: '2-digit'});;
									var eDay = new Date(data.enddate).toLocaleDateString("zh-TW", {year: 'numeric', month: '2-digit', day: '2-digit'});;
									
									var pair = "可配對";
									if (data.pair != 0) {
										pair = "不可配對"
									}
									
								document.getElementById('title').innerHTML = data.title;
								document.getElementById('introduction').innerHTML = data.introduction;
								document.getElementById('postmember').innerHTML = data.userprofiles.userdetail.nickname + "<br>" + pDay;
								document.getElementById('tag').innerHTML = result;
								document.getElementById('startday').innerHTML = sDay + "<br><br><br>";
								document.getElementById('endday').innerHTML = eDay + "<br><br><br>";
								document.getElementById('acceptablenum').innerHTML = data.acceptablenum;
								document.getElementById('currentnum').innerHTML = data.currentnum;
								document.getElementById('camparea').innerHTML = data.camparea;
								document.getElementById('pair').innerHTML = pair;
								const applynum = document.getElementById("applypeople");
								applynum.setAttribute("max", data.acceptablenum);
								applynum.setAttribute("min", 1);
								
								initiatingUser = data.userprofiles.uid;
								
								if(user == initiatingUser){
									var updateData = "";
									updateData += '<form action="/morari/team/guestupdate.controller" method="get" name="guestupdate" id="guestupdate" novalidate="novalidate"><div class="control-group">'+
									'<input type="hidden" name="dnum" value="' + data.initiatingnum + '">' +
	              					'<input type="hidden" name="pman" value="' + data.userprofiles.uid + '">' +
									'<div class="button">' +
									'<button type="submit" id="guestupdate" >修改</button>' +
									'</div></div></form>'
									
									document.getElementById('update').innerHTML = updateData;
								}
							});
							
					});
		    	
		    	
		    	
		    	fetch('/morari/team/selectMessage.controller/{'+ num +"}" , { method: 'GET' }).then(
						function (response) {
							if (response.status != 200) {
								console.log(response.satus);
								return;
							}
							
							console.log(response);

							response.json().then(function (data) {
								
								var messageData = "";
									
								for(let i = 0; i < data.length; i++){
									if(data[i].userprofiles.uid == user){
										messageData += '<div class="button"><button type="button" onclick="deleteMessage(' + data[i].messageid + ')">刪除</button></div>'
									}
									var pDay = new Date(data[i].postday).toLocaleDateString("zh-TW", {year: 'numeric', month: '2-digit', day: '2-digit', 
										hour: '2-digit', minute: '2-digit', second: '2-digit'});
									console.log(pDay);
									console.log(data[i].userprofiles.uid);
									console.log(data[i].message);
									messageData += "<h3>" + data[i].userprofiles.userdetail.nickname + ' 說：</h3><ul calss="room-size">' + data[i].message + '<i class="fa fa-arrow-right"></i>發文時間：' + pDay + "</ul><br>"
								}
								
								document.getElementById('messageview').innerHTML = messageData;
								
							});
							
				});
		    	
		    	fetch('/morari/team/findApplyByUserAndInitiatingnum.controller/' +  user + "/" + num, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: null
				})
					.then(function (response) {
						if (response.status == 200) {
								
						}
						response.json().then(function (data){
							console.log(data[0].limit)
							limit = data[0].limit;
							pair = data[0].pairstate;
						});
				});
	    		
	    	})
	    	
	    	
	    	
	    	const form = document.getElementById('sentMessage');
	    	
	    	form.addEventListener('submit', function (event) {
				event.preventDefault();
				
				const formData = Array.from(this.elements).reduce(function (data, element) {
				    data[element.name] = element.value;
				    return data;
				}, {});
				
				let arr = [];
				var value = formData['message'];
				arr.push(num);
				arr.push(value);
				delete formData['message'];
				
				const array = JSON.stringify(arr);

				console.log(array);

				var result = confirm("確定要新增留言嗎");

				if (result) {

					fetch('/morari/team/insertMessage.controller/' +  user, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: array
					})
						.then(function (response) {
							if (response.status == 200) {
								location.href = "/morari/team/moreInformation.controller/" + num ;
							}
				});

				}
				
			});
	    	
	    	
			const apply = document.getElementById('sentApply');
	    	
	    	apply.addEventListener('submit', function (event) {
	    		event.preventDefault();
	    		
	    		if(user === initiatingUser){
	    			window.alert("不可以對自己的表單申請")
	    			return;
	    		}else if(limit > 2){
	    			window.alert("不可向此表單發出申請\n可能是達成了邀請上限，或是遭到發起人永久拒絕")
	    			return;
	    		}else if(pair > 0){
	    			window.alert("本筆揪團已經被接受了，請不要再按了")
	    			return;
	    		}
	    		
	    		const formData = Array.from(this.elements).reduce(function (data, element) {
				    data[element.name] = element.value;
				    return data;
				}, {});
	    		
	    		formData["initiatingnumber"] = num;
	    		
	    		const json = JSON.stringify(formData);
	    		
	    		fetch('/morari/team/insertApply.controller/' +  user, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: json
				})
					.then(function (response) {
						if (response.status == 200) {
							window.alert("成功發出申請");
						}
				});
	    		
			});
	    	
	    });
});
  
function deleteMessage(dvalue){
		
		var result = confirm("確定要刪除留言嗎");
		if (result) {

			fetch('/morari/team/deleteMessage.controller/' +  dvalue, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: null
			})
				.then(function (response) {
					if (response.status == 200) {
						location.href = "/morari/team/moreInformation.controller/" + num ;
					}
			});

		}
}

	
 </script>



</body>

</html>